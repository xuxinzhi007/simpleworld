name: 自动打包 Android APK

# 触发条件：push 到 main 分支时触发
on:
  push:
    branches: [ main ]

# 工作流任务
jobs:
  build-android:
    runs-on: ubuntu-latest  # 使用 Ubuntu 系统运行

    steps:
      # 步骤 1：拉取仓库代码
      - name: 拉取代码
        uses: actions/checkout@v4

      # 步骤 2：设置 JDK 环境（Android 打包需要）
      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 步骤 3：安装 Android SDK 和 NDK
      - name: 安装 Android SDK
        uses: android-actions/setup-android@v3

      # 步骤 4：配置 Gradle 权限
      - name: 授权 Gradle 执行
        run: chmod +x gradlew

      # 步骤 5：编译 LÖVE2D 引擎并打包游戏
      - name: 编译并打包 APK
        run: |
          # 克隆 LÖVE2D Android 打包模板（社区维护，简化配置）
          git clone --depth 1 --branch 11.5 https://github.com/love2d/love-android.git love-android
          
          # 将你的游戏代码复制到模板的 assets 目录（自动压缩为 game.love）
          cp -r . love-android/app/src/main/assets/game
          
          # 进入模板目录，执行打包命令
          cd love-android
          ./gradlew assembleRelease

      # 步骤 6：上传打包好的 APK 到 GitHub  Releases
      - name: 上传 APK 到 Releases
        uses: softprops/action-gh-release@v2
        with:
          files: love-android/app/build/outputs/apk/release/app-release.apk
          name: 自动打包 Android 版本 ${{ github.sha }}
          tag_name: android-${{ github.sha }}